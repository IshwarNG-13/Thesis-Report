<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Layout Controller</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>
    <style>
        /* --- FONTS --- */
        @font-face { font-family: 'AdventPro'; src: url('fonts/AdventPro-VariableFont_wdth,wght.ttf') format('truetype'); }
        @font-face { font-family: 'Allerta'; src: url('fonts/AllertaStencil-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'Amarante'; src: url('fonts/Amarante-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'Aubrey'; src: url('fonts/Aubrey-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'Audiowide'; src: url('fonts/Audiowide-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'Barrio'; src: url('fonts/Barrio-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'BBHSans'; src: url('fonts/BBHSansBartle-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'Creepster'; src: url('fonts/Creepster-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'Domine'; src: url('fonts/Domine-VariableFont_wght.ttf') format('truetype'); }
        @font-face { font-family: 'DotoBlack'; src: url('fonts/Doto-Black.ttf') format('truetype'); }
        @font-face { font-family: 'DotoVar'; src: url('fonts/Doto-VariableFont_ROND,wght.ttf') format('truetype'); }
        @font-face { font-family: 'FascinateInline'; src: url('fonts/FascinateInline-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'Fontdiner'; src: url('fonts/FontdinerSwanky-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'Iceberg'; src: url('fonts/Iceberg-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'Inter28'; src: url('fonts/Inter_28pt-BlackItalic.ttf') format('truetype'); }
        @font-face { font-family: 'Kablammo'; src: url('fonts/Kablammo-Regular-VariableFont_MORF.ttf') format('truetype'); }
        @font-face { font-family: 'Leckerli'; src: url('fonts/LeckerliOne-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'MouseMemoirs'; src: url('fonts/MouseMemoirs-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'Nosifer'; src: url('fonts/Nosifer-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'PermanentMarker'; src: url('fonts/PermanentMarker-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'RedRoseBold'; src: url('fonts/RedRose-Bold.ttf') format('truetype'); }
        @font-face { font-family: 'RedRoseVar'; src: url('fonts/RedRose-VariableFont_wght.ttf') format('truetype'); }
        @font-face { font-family: 'RubikBubbles'; src: url('fonts/RubikBubbles-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'RubikGlitch'; src: url('fonts/RubikGlitch-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'StalinistOne'; src: url('fonts/StalinistOne-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'TiltPrism'; src: url('fonts/TiltPrism.ttf') format('truetype'); }
        @font-face { font-family: 'ViaodaLibre'; src: url('fonts/ViaodaLibre-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'Workbench'; src: url('fonts/Workbench-Regular-VariableFont_BLED,SCAN.ttf') format('truetype'); }
        @font-face { font-family: 'GoogleSansCode'; src: url('fonts/GoogleSansCode-Italic-VariableFont_wght.ttf') format('truetype'); }
        @font-face { font-family: 'DotoExtraBold'; src: url('fonts/Doto-ExtraBold.ttf') format('truetype'); }

        /* --- VARIABLES --- */
        :root {
            --color-bg: #01161e;
            --color-surface: #eff6e0;
            --color-text-main: #01161e;
            --color-text-muted: #124559;
            --color-primary: #598392;
            --color-accent: #aec3b0;
        }

        /* --- GLOBAL --- */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'PermanentMarker', sans-serif;
            background-color: var(--color-bg);
        }

        #cy {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        /* --- PANELS --- */
        .panel {
            position: absolute;
            top: 2.5rem;
            width: 18rem;
            background-color: var(--color-surface);
            border: 2px solid var(--color-accent);
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 50;
            cursor: grab;
        }

        #draggablePanel { left: 2.5rem; }
        #statsPanel { right: 2.5rem; }

        .panel-header {
            background-color: var(--color-primary);
            color: var(--color-surface);
            font-weight: bold;
            text-align: center;
            padding: 0.625rem 0.5rem;
            border-radius: 0.5rem;
            cursor: move;
            margin-bottom: 1rem;
            user-select: none;
            font-family: DotoExtraBold;
            font-size: 1.25rem;
        }

        /* --- FORM ELEMENTS --- */
        .form-group { margin-bottom: 1.25rem; }

        .form-label {
            display: block;
            color: var(--color-text-main);
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .form-select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: none;
            background-color: var(--color-accent);
            color: var(--color-text-main);
            font-weight: 600;
            cursor: pointer;
            font-family: Leckerli;
        }

        /* --- SLIDERS --- */
        .slider-group { margin-bottom: 1.25rem; }
        
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-bottom: 1rem;
        }

        .slider-label {
            color: var(--color-text-main);
            font-weight: 500;
        }

        .slider {
            width: 100%;
            height: 0.5rem;
            border-radius: 9999px;
            background-color: var(--color-accent);
            appearance: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            border: none;
        }

        .slider-value {
            color: var(--color-text-muted);
            font-size: 0.875rem;
        }

        /* --- BUTTONS --- */
        .btn {
            width: 100%;
            padding: 0.625rem;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-surface);
        }

        .btn-primary:hover {
            background-color: var(--color-accent);
            color: var(--color-text-main);
            transform: scale(1.05);
        }

        .btn-danger {
            background-color: #dc2626;
            color: var(--color-surface);
        }

        .btn-danger:hover {
            background-color: #b91c1c;
            transform: scale(1.05);
        }

        .btn-draw-active {
            background-color: var(--color-accent);
            color: var(--color-text-main);
        }

        .hidden { display: none; }

        /* --- STATS --- */
        .stat-box {
            background-color: rgba(174, 195, 176, 0.3);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .stat-label {
            color: var(--color-text-main);
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            color: var(--color-primary);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-status {
            color: var(--color-text-muted);
            font-weight: 600;
        }

        .history-container {
            margin-top: 1rem;
            background-color: rgba(174, 195, 176, 0.2);
            border-radius: 0.5rem;
            padding: 0.75rem;
            max-height: 16rem;
            overflow-y: auto;
        }

        .history-title {
            color: var(--color-text-main);
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .history-content {
            color: var(--color-text-muted);
            font-size: 0.75rem;
            font-family: monospace;
        }

        .history-content > div { margin-bottom: 0.25rem; }

        .history-empty {
            text-align: center;
            padding: 0.5rem 0;
        }

        .cursor-grabbing { cursor: grabbing !important; }
        
        /* Flex row for import/export buttons */
        .btn-row {
            display: flex;
            gap: 10px;
            margin-bottom: 0.5rem;
        }
        
        .btn-row .btn {
            margin-bottom: 0;
        }
    </style>
</head>
<body>

<div id="cy"></div>

<div id="draggablePanel" class="panel">
    <div class="panel-header" id="dragHandle">
        ‚öôÔ∏è Layout Controls
    </div>

    <div class="form-group">
        <label class="form-label" for="layoutSelect">Select Layout:</label>
        <select id="layoutSelect" class="form-select">
            <option value="eades">EADES</option>
            <option value="fruchterman">Fruchterman-Reingold</option>
        </select>
    </div>

    <div class="slider-group">
        <div class="slider-container" id="slider1Container">
            <label class="slider-label" for="myRange1">C1 (Spring):</label>
            <input type="range" id="myRange1" class="slider" min="0.1" max="10" step="0.1" value="2">
            <span id="rangeValue1" class="slider-value">2</span>
        </div>
        <div class="slider-container" id="slider2Container">
            <label class="slider-label" for="myRange2">C2 (Opt. Dist):</label>
            <input type="range" id="myRange2" class="slider" min="10" max="200" step="1" value="100">
            <span id="rangeValue2" class="slider-value">100</span>
        </div>
        <div class="slider-container" id="slider3Container">
            <label class="slider-label" for="myRange3">C3 (Repulsion):</label>
            <input type="range" id="myRange3" class="slider" min="100" max="20000" step="100" value="10000">
            <span id="rangeValue3" class="slider-value">10000</span>
        </div>
        <div class="slider-container" id="slider4Container">
            <label class="slider-label" for="myRange4">C4 (Damping):</label>
            <input type="range" id="myRange4" class="slider" min="0.01" max="1" step="0.01" value="0.5">
            <span id="rangeValue4" class="slider-value">0.5</span>
        </div>
        <div class="slider-container">
            <label class="slider-label" for="epsilonRange">Epsilon (Threshold):</label>
            <input type="range" id="epsilonRange" class="slider" min="0.01" max="10" step="0.01" value="1">
            <span id="epsilonValue" class="slider-value">1</span>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label" for="iterationRange">Iterations:</label>
        <input type="range" id="iterationRange" class="slider" min="1" max="500" value="250">
        <span id="iterationValue" class="slider-value">250</span>
    </div>

    <button class="btn btn-primary" id="randomBtn">RANDOM</button>
    <button class="btn btn-primary" id="drawModeBtn">Enable Draw Mode</button>
    
    <div class="btn-row">
        <button class="btn btn-primary" id="exportBtn">Export JSON</button>
        <button class="btn btn-primary" id="importBtn">Import JSON</button>
    </div>
    <input type="file" id="fileInput" style="display: none;" accept=".json">

    <button class="btn btn-primary" id="startBtn">START</button>
    <button class="btn btn-primary hidden" id="stopBtn">STOP</button>
    <button class="btn btn-danger" id="resetBtn">RESET GRAPH</button>
</div>

<div id="statsPanel" class="panel">
    <div class="panel-header" id="statsDragHandle">
        üìä Force Statistics
    </div>

    <div>
        <div class="stat-box">
            <div class="stat-label">Current Iteration:</div>
            <div id="currentIteration" class="stat-value">0</div>
        </div>

        <div class="stat-box">
            <div class="stat-label">Max Force:</div>
            <div id="maxForce" class="stat-value">0.00</div>
        </div>

        <div class="stat-box">
            <div class="stat-label">Avg Force:</div>
            <div id="avgForce" class="stat-value">0.00</div>
        </div>

        <div class="stat-box">
            <div class="stat-label">Status:</div>
            <div id="status" class="stat-status">Idle</div>
        </div>
    </div>

    <div class="history-container">
        <div class="history-title">Force History:</div>
        <div id="forceHistory" class="history-content">
            <div class="history-empty">No data yet</div>
        </div>
    </div>
</div>

<script>
    const cy = cytoscape({
        container: document.getElementById('cy'),
        style: [
            {
                selector: 'node',
                style: {
                    'background-color': '#aec3b0',
                    'border-width': 2,
                    'border-color': '#eff6e0',
                    'label': 'data(id)',
                    'color': '#eff6e0',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': '12px',
                    'font-weight': 'bold',
                    'width': 20,
                    'height': 20
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': '#aec3b0',
                    'opacity': 0.7
                }
            }
        ],
        layout: {
            name: 'circle',
            radius: 200
        }
    });

    // Make Left Panel Draggable
    const panel = document.getElementById("draggablePanel");
    const handle = document.getElementById("dragHandle");
    let isDragging = false, offsetX = 0, offsetY = 0;

    handle.addEventListener("mousedown", (e) => {
        isDragging = true;
        offsetX = e.clientX - panel.offsetLeft;
        offsetY = e.clientY - panel.offsetTop;
        panel.classList.add('cursor-grabbing');
    });

    document.addEventListener("mouseup", () => {
        isDragging = false;
        panel.classList.remove('cursor-grabbing');
    });

    document.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        panel.style.left = `${e.clientX - offsetX}px`;
        panel.style.top = `${e.clientY - offsetY}px`;
    });

    // Make Right Stats Panel Draggable
    const statsPanel = document.getElementById("statsPanel");
    const statsHandle = document.getElementById("statsDragHandle");
    let isStatsDragging = false, statsOffsetX = 0, statsOffsetY = 0;

    statsHandle.addEventListener("mousedown", (e) => {
        isStatsDragging = true;
        statsOffsetX = e.clientX - statsPanel.offsetLeft;
        statsOffsetY = e.clientY - statsPanel.offsetTop;
        statsPanel.classList.add('cursor-grabbing');
    });

    document.addEventListener("mousemove", (e) => {
        if (!isStatsDragging) return;
        statsPanel.style.left = `${e.clientX - statsOffsetX}px`;
        statsPanel.style.top = `${e.clientY - statsOffsetY}px`;
    });

    // Slider Value Display
    ["myRange1", "myRange2", "myRange3", "myRange4", "iterationRange", "epsilonRange"].forEach(id => {
        const slider = document.getElementById(id);
        const output = document.getElementById(id.replace('myRange', 'rangeValue').replace('iterationRange', 'iterationValue').replace('epsilonRange', 'epsilonValue'));
        if (output) {
            slider.oninput = () => output.textContent = slider.value;
        }
    });

    // Random Button
    document.getElementById("randomBtn").addEventListener("click", () => {
        const selectedLayout = document.getElementById('layoutSelect').value;

        if (selectedLayout === 'eades') {
            const slider1 = document.getElementById('myRange1');
            const slider2 = document.getElementById('myRange2');
            const slider3 = document.getElementById('myRange3');
            const slider4 = document.getElementById('myRange4');

            const rand1 = (Math.random() * 9.9 + 0.1).toFixed(1);
            const rand2 = Math.floor(Math.random() * 190 + 10);
            const rand3 = Math.floor(Math.random() * 19900 + 100);
            const rand4 = (Math.random() * 0.99 + 0.01).toFixed(2);

            slider1.value = rand1;
            slider2.value = rand2;
            slider3.value = rand3;
            slider4.value = rand4;

            document.getElementById('rangeValue1').textContent = rand1;
            document.getElementById('rangeValue2').textContent = rand2;
            document.getElementById('rangeValue3').textContent = rand3;
            document.getElementById('rangeValue4').textContent = rand4;
        } else if (selectedLayout === 'fruchterman') {
            const slider1 = document.getElementById('myRange1');
            const slider2 = document.getElementById('myRange2');

            const rand1 = Math.floor(Math.random() * 190 + 10);
            const rand2 = (Math.random() * 0.99 + 0.01).toFixed(2);

            slider1.value = rand1;
            slider2.value = rand2;

            document.getElementById('rangeValue1').textContent = rand1;
            document.getElementById('rangeValue2').textContent = rand2;
        }

        const sliderIter = document.getElementById('iterationRange');
        const sliderEpsilon = document.getElementById('epsilonRange');

        const randIter = Math.floor(Math.random() * 499 + 1);
        const randEpsilon = (Math.random() * 9.99 + 0.01).toFixed(2);

        sliderIter.value = randIter;
        sliderEpsilon.value = randEpsilon;

        document.getElementById('iterationValue').textContent = randIter;
        document.getElementById('epsilonValue').textContent = randEpsilon;
    });

    class GraphVisualizer {
        constructor() {
            this.directed = false;
            this.weighted = false;
            this.labeled = true;
            this.adjList = {};
            this.nodeCount = 0;
            this.selectedNode = null;
            this.drawMode = false;
            this.animationRunning = false;
            this.forceHistory = [];
            this.epsilon = 0;
            this.avgForce = 0;
            this.updateControlPanel();
            this.setupEventListeners();
        }

        updateControlPanel() {
            const layout = document.getElementById('layoutSelect').value;
            const slider1 = document.getElementById('myRange1');
            const slider2 = document.getElementById('myRange2');
            const slider3 = document.getElementById('myRange3');
            const slider4 = document.getElementById('myRange4');

            const label1 = document.querySelector('#slider1Container .slider-label');
            const label2 = document.querySelector('#slider2Container .slider-label');
            const label3 = document.querySelector('#slider3Container .slider-label');
            const label4 = document.querySelector('#slider4Container .slider-label');

            if (layout === 'eades') {
                // EADES parameters
                label1.textContent = 'C1 (Spring):';
                label2.textContent = 'C2 (Opt. Dist):';
                label3.textContent = 'C3 (Repulsion):';
                label4.textContent = 'C4 (Damping):';

                slider1.min = '0.1';
                slider1.max = '10';
                slider1.step = '0.1';
                slider1.value = '2';

                slider2.min = '10';
                slider2.max = '200';
                slider2.step = '1';
                slider2.value = '100';

                slider3.min = '100';
                slider3.max = '20000';
                slider3.step = '100';
                slider3.value = '10000';

                slider4.min = '0.01';
                slider4.max = '1';
                slider4.step = '0.01';
                slider4.value = '0.5';

                document.getElementById('slider1Container').style.display = 'flex';
                document.getElementById('slider2Container').style.display = 'flex';
                document.getElementById('slider3Container').style.display = 'flex';
                document.getElementById('slider4Container').style.display = 'flex';

            } else if (layout === 'fruchterman') {
                // Fruchterman-Reingold parameters
                label1.textContent = '‚Ñì:';
                label2.textContent = 'Damping:';

                slider1.min = '10';
                slider1.max = '200';
                slider1.step = '1';
                slider1.value = '100';

                slider2.min = '0.01';
                slider2.max = '1';
                slider2.step = '0.01';
                slider2.value = '0.5';

                document.getElementById('slider1Container').style.display = 'flex';
                document.getElementById('slider2Container').style.display = 'flex';
                document.getElementById('slider3Container').style.display = 'none';
                document.getElementById('slider4Container').style.display = 'none';
            }

            // Update displayed values
            document.getElementById('rangeValue1').textContent = slider1.value;
            document.getElementById('rangeValue2').textContent = slider2.value;
            document.getElementById('rangeValue3').textContent = slider3.value;
            document.getElementById('rangeValue4').textContent = slider4.value;
        }

        setupEventListeners() {
            cy.on('click', (evt) => {
                if (evt.target === cy && this.drawMode) this.addNode(evt.position);
            });

            cy.on('click', 'node', (evt) => {
                if (!this.drawMode) return;
                const node = evt.target;
                if (this.selectedNode === null) {
                    this.selectNode(node);
                } else {
                    if (node.id() === this.selectedNode.id()) {
                        alert('Self loops are not allowed.');
                    } else {
                        this.addEdge(this.selectedNode, node);
                    }
                    this.deselectNode();
                }
            });

            document.getElementById('drawModeBtn').addEventListener('click', () => {
                this.drawMode = !this.drawMode;
                const btn = document.getElementById('drawModeBtn');
                if (this.drawMode) {
                    btn.textContent = 'Disable Draw Mode';
                    btn.classList.add('btn-draw-active');
                    this.deselectNode();
                } else {
                    btn.textContent = 'Enable Draw Mode';
                    btn.classList.remove('btn-draw-active');
                }
            });

            document.getElementById('resetBtn').addEventListener('click', () => {
                this.resetGraph();
            });

            // NEW: Import/Export Listeners
            document.getElementById('exportBtn').addEventListener('click', () => this.exportGraph());
            
            document.getElementById('importBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', (e) => this.importGraph(e));
        }

        // NEW: Export Function
        exportGraph() {
            const json = cy.json();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "graph_data.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // NEW: Import Function
        importGraph(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    
                    if (this.animationRunning) {
                        this.stopAnimation();
                    }

                    // Load elements into Cytoscape
                    cy.json(json);

                    // Re-calculate nodeCount so new nodes have unique IDs
                    let maxId = 0;
                    cy.nodes().forEach(node => {
                        const id = parseInt(node.id());
                        if (!isNaN(id) && id > maxId) {
                            maxId = id;
                        }
                    });
                    this.nodeCount = maxId;

                    // Update UI just in case
                    this.updateControlPanel();
                    
                } catch (err) {
                    alert("Error parsing JSON file");
                    console.error(err);
                }
            };
            reader.readAsText(file);
            
            // Reset input so you can load the same file again if needed
            event.target.value = '';
        }

        resetGraph() {
            if (this.animationRunning) {
                this.stopAnimation();
            }

            cy.elements().remove();

            this.nodeCount = 0;
            this.selectedNode = null;
            this.forceHistory = [];
            this.epsilon = 0;
            this.avgForce = 0;
            this.adjList = {};

            document.getElementById('currentIteration').textContent = '0';
            document.getElementById('maxForce').textContent = '0.00';
            document.getElementById('avgForce').textContent = '0.00';
            document.getElementById('status').textContent = 'Idle';
            document.getElementById('forceHistory').innerHTML = '<div class="history-empty">No data yet</div>';

            this.deselectNode();
        }

        addNode(position) {
            this.nodeCount++;
            let label = String(this.nodeCount);

            while (cy.getElementById(label).length > 0) {
                this.nodeCount++;
                label = String(this.nodeCount);
            }

            cy.add({
                group: 'nodes',
                data: { id: label },
                position: position
            });
        }

        selectNode(node) {
            this.selectedNode = node;
            node.style({ 'background-color': '#598392', 'border-color': '#eff6e0' });
        }

        deselectNode() {
            if (this.selectedNode) {
                this.selectedNode.style({ 'background-color': '#aec3b0' });
                this.selectedNode = null;
            }
        }

        addEdge(sourceNode, targetNode) {
            const src = sourceNode.id();
            const tgt = targetNode.id();
            const edgeId = `${src}-${tgt}`;
            const reverseId = `${tgt}-${src}`;

            if (cy.getElementById(edgeId).length > 0 || cy.getElementById(reverseId).length > 0) {
                alert('This edge already exists.');
                return;
            }
            cy.add({ group: 'edges', data: { id: edgeId, source: src, target: tgt } });
        }

        updateStats(iteration, maxForce, avgForce) {
            document.getElementById('currentIteration').textContent = iteration;
            document.getElementById('maxForce').textContent = maxForce.toFixed(4);
            document.getElementById('avgForce').textContent = avgForce.toFixed(4);

            const historyDiv = document.getElementById('forceHistory');
            const entry = document.createElement('div');
            entry.textContent = `Iter ${iteration}: Max=${maxForce.toFixed(2)}, Avg=${avgForce.toFixed(2)}`;

            if (this.forceHistory.length === 0) {
                historyDiv.innerHTML = '';
            }

            historyDiv.appendChild(entry);
            this.forceHistory.push({ iteration, maxForce, avgForce });

            historyDiv.scrollTop = historyDiv.scrollHeight;

            if (this.forceHistory.length > 50) {
                this.forceHistory.shift();
                if (historyDiv.children.length > 50) {
                    historyDiv.removeChild(historyDiv.firstChild);
                }
            }
        }

        EADES() {
            const nodes = cy.nodes();
            const edges = cy.edges();
            const c_spring = parseFloat(document.getElementById('myRange1').value);
            const ell = parseFloat(document.getElementById('myRange2').value);
            const c_rep = parseFloat(document.getElementById('myRange3').value);
            const delta = parseFloat(document.getElementById('myRange4').value);

            const p = {};
            nodes.forEach(node => {
                const pos = node.position();
                p[node.id()] = { x: pos.x, y: pos.y };
            });

            const F = {};
            nodes.forEach(node => {
                F[node.id()] = { x: 0, y: 0 };
            });

            nodes.forEach(u => {
                const u_id = u.id();
                const p_u = p[u_id];

                nodes.forEach(v => {
                    if (u.id() === v.id()) return;

                    const v_id = v.id();
                    const p_v = p[v_id];

                    const dx = p_v.x - p_u.x;
                    const dy = p_v.y - p_u.y;
                    const distanceSq = dx * dx + dy * dy;

                    if (distanceSq === 0) return;

                    const distance = Math.sqrt(distanceSq);

                    const f_rep_magnitude = c_rep / distanceSq;
                    const unit_x = -dx / distance;
                    const unit_y = -dy / distance;

                    F[u_id].x += f_rep_magnitude * unit_x;
                    F[u_id].y += f_rep_magnitude * unit_y;
                });

                u.connectedEdges().forEach(edge => {
                    const v = edge.source().id() === u_id ? edge.target() : edge.source();
                    const v_id = v.id();
                    const p_v = p[v_id];

                    const dx = p_v.x - p_u.x;
                    const dy = p_v.y - p_u.y;
                    const distance = Math.sqrt(dx * dx + dy * dy) || 0.01;

                    const f_spring_magnitude = c_spring * Math.log(distance / ell);
                    const unit_x = dx / distance;
                    const unit_y = dy / distance;

                    F[u_id].x += f_spring_magnitude * unit_x;
                    F[u_id].y += f_spring_magnitude * unit_y;
                });
            });

            let maxForce = 0;
            let totalForce = 0;

            nodes.forEach(u => {
                const u_id = u.id();
                const dampedFx = delta * F[u_id].x;
                const dampedFy = delta * F[u_id].y;

                const forceMag = Math.sqrt(dampedFx * dampedFx + dampedFy * dampedFy);
                maxForce = Math.max(maxForce, forceMag);
                totalForce += forceMag;

                p[u_id].x += dampedFx;
                p[u_id].y += dampedFy;
            });

            const avgForce = nodes.length > 0 ? totalForce / nodes.length : 0;
            this.avgForce = avgForce;

            nodes.forEach(node => {
                node.position(p[node.id()]);
            });

            return { maxForce, avgForce };
        }

        FruchtermanReingold() {
            const nodes = cy.nodes();
            const edges = cy.edges();
            // In FR, 'k' is the optimal distance (ell in your code)
            const k = parseFloat(document.getElementById('myRange1').value);

            // 1. Initialize forces
            const F = {};
            nodes.forEach(node => F[node.id()] = { x: 0, y: 0 });

            const p = {};
            nodes.forEach(node => p[node.id()] = node.position());

            // 2. Calculate Repulsive Forces (k^2 / d)
            nodes.forEach(v => {
                nodes.forEach(u => {
                    if (v.id() === u.id()) return;

                    const dx = p[v.id()].x - p[u.id()].x;
                    const dy = p[v.id()].y - p[u.id()].y;
                    const dist = Math.sqrt(dx*dx + dy*dy) || 0.01;

                    if (dist > 0) {
                        const fr = (k * k) / dist;
                        F[v.id()].x += (dx / dist) * fr;
                        F[v.id()].y += (dy / dist) * fr;
                    }
                });
            });

            // 3. Calculate Attractive Forces (d^2 / k)
            edges.forEach(edge => {
                const uId = edge.source().id();
                const vId = edge.target().id();

                const dx = p[vId].x - p[uId].x;
                const dy = p[vId].y - p[uId].y;
                const dist = Math.sqrt(dx*dx + dy*dy) || 0.01;

                const fa = (dist * dist) / k;

                const xComp = (dx / dist) * fa;
                const yComp = (dy / dist) * fa;

                F[vId].x -= xComp;
                F[vId].y -= yComp;

                F[uId].x += xComp;
                F[uId].y += yComp;
            });

            // 4. Update Positions
            const currentTemperature = parseFloat(document.getElementById('myRange2').value);

            let maxForce = 0;
            let totalForce = 0;

            nodes.forEach(n => {
                const nid = n.id();
                const disp = { x: F[nid].x, y: F[nid].y };
                const dispMag = Math.sqrt(disp.x*disp.x + disp.y*disp.y) || 0.01;

                // Limit the movement by the temperature
                const magnitude = Math.min(dispMag, currentTemperature);

                const moveX = (disp.x / dispMag) * magnitude;
                const moveY = (disp.y / dispMag) * magnitude;

                p[nid].x += moveX;
                p[nid].y += moveY;

                maxForce = Math.max(maxForce, dispMag);
                totalForce += dispMag;
            });

            // Apply new positions
            nodes.forEach(node => {
                node.position(p[node.id()]);
            });

            const avgForce = nodes.length > 0 ? totalForce / nodes.length : 0;
            
            // --- FIX: Update class property for stopping condition ---
            this.avgForce = avgForce; 
            // -----------------------

            return { maxForce, avgForce };
        }

        startAnimation() {
            if (this.animationRunning) return;

            this.animationRunning = true;
            this.forceHistory = [];
            this.avgForce = Infinity;

            const maxIterations = parseInt(document.getElementById('iterationRange').value);
            this.epsilon = parseFloat(document.getElementById('epsilonRange').value);
            const selectedLayout = document.getElementById('layoutSelect').value;
            let currentIteration = 0;

            document.getElementById('status').textContent = 'Running...';
            document.getElementById('forceHistory').innerHTML = '';

            const animate = () => {
                if (!this.animationRunning) {
                    document.getElementById('status').textContent = 'Stopped';
                    return;
                }

                if (currentIteration >= maxIterations) {
                    this.stopAnimation();
                    document.getElementById('status').textContent = 'Completed (Max Iterations)';
                    return;
                }

                if (this.avgForce < this.epsilon && currentIteration > 0) {
                    this.stopAnimation();
                    document.getElementById('status').textContent = 'Converged (Avg Force < Epsilon)';
                    return;
                }

                currentIteration++;

                let stats = { maxForce: 0, avgForce: 0 };
                if (selectedLayout === 'eades') {
                    stats = this.EADES();
                } else if (selectedLayout === 'fruchterman') {
                    stats = this.FruchtermanReingold();
                }

                this.updateStats(currentIteration, stats.maxForce, stats.avgForce);

                requestAnimationFrame(animate);
            };

            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('stopBtn').classList.remove('hidden');
            animate();
        }

        stopAnimation() {
            this.animationRunning = false;
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
        }
    }

    let graph = new GraphVisualizer();

    document.getElementById('layoutSelect').addEventListener('change', () => {
        graph.updateControlPanel();
    });

    document.getElementById('startBtn').addEventListener('click', () => {
        if (cy.nodes().length === 0) {
            alert('Please add some nodes first using Draw Mode.');
            return;
        }
        graph.startAnimation();
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
        graph.stopAnimation();
    });
</script>

</body>
</html>
